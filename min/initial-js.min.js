var app=angular.module("app",["ngRoute"]);
app.config(["$routeProvider","$sceProvider","$locationProvider","$controllerProvider","$provide","$compileProvider","$filterProvider","$sceDelegateProvider",function(a,g,d,k,f,b,h,e){e.resourceUrlWhitelist(["self","https://script.google.com"]);e=window.location.search;a.when("/",{templateUrl:"src/views/home.php"+e}).when("/tag/:category",{templateUrl:"src/views/category.php"+e,controller:"categoryCtrl",controllerAs:"cat"}).when("/search/:category",{templateUrl:"src/views/category.php"+e,controller:"categoryCtrl",
controllerAs:"cat"}).when("/id/:id",{controller:"gameCtrl",controllerAs:"g",templateUrl:"src/views/game.php"+e}).when("/submit",{templateUrl:"src/views/submit.php"+e}).when("/cookies",{templateUrl:"src/views/policy.php"+e}).when("/contact",{templateUrl:"src/views/contact.php"+e}).when("/game/:id",{redirectTo:"/id/:id"}).when("/tag",{redirectTo:"/"}).when("/403",{templateUrl:"src/views/error.php?error_code=403"}).when("/401",{templateUrl:"src/views/error.php?error_code=401"}).otherwise({templateUrl:"src/views/error.php?error_code=404"});
g.enabled(!0);d.html5Mode(!0);app._controller=app.controller;app._service=app.service;app._factory=app.factory;app._value=app.value;app._directive=app.directive;app.controller=function(a,b){k.register(a,b);return this};app.service=function(a,b){f.service(a,b);return this};app.factory=function(a,b){f.factory(a,b);return this};app.value=function(a,b){f.value(a,b);return this};app.directive=function(a,d){b.directive(a,d);return this};app.filter=function(a,b){h.register(a,b);return this}}]);
app.service("initialJSON",["$http","$lhttp",function(a,g){this.pass=encodeURIComponent(window.location.search.slice(1)+window.location.hash.slice(1));var d="https://static.thorin-games.tk/js/initialJSON.php";0<this.pass.length&&(d+="?pass="+this.pass);this.json=g.get(d);this.jquery=g.get("https://code.jquery.com/jquery-2.2.3.min.js",0);this.jquery.then(function(a){eval(a)})}]);app.directive("script",function(){return{restrict:"E",scope:!1,link:function(a,g,d){"text/javascript-lazy"===d.type&&eval(g[0].text)}}});
app.service("$lhttp",["$http","$q","$timeout",function(a,g,d){var k=this;k.ldbOn=!0;try{!function(){function a(b,e){return d?void(d.transaction("s").objectStore("s").get(b).onsuccess=function(a){e(a.target.result&&a.target.result.v||null)}):void setTimeout(function(){a(b,e)},100)}var b=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;if(!b)return void console.error("indexDB not supported");var d,e={k:"",v:""},b=b.open("d2",1);b.onsuccess=function(a){d=this.result};
b.onerror=function(a){console.error("indexedDB request error");console.log(a)};b.onupgradeneeded=function(a){d=null;a.target.result.createObjectStore("s",{keyPath:"k"}).transaction.oncomplete=function(a){d=a.target.db}};window.ldb={get:a,set:function(a,b){e.k=a;e.v=b;d.transaction("s","readwrite").objectStore("s").put(e)}}}()}catch(f){console.warn("Unable to use lbd, using localStorage instead. Error:",f),k.ldbOn=!1}k.get=function(f,b,h,e){var l=g.defer();"undefined"===typeof h&&(h={});h.timeout=
l.promise;h=a.get(f,h);h.success(function(a){try{ldb.set(f,JSON.stringify(a))}catch(p){try{localStorage[f]=JSON.stringify(a)}catch(c){console.log("Couldn't save "+f+"-data to storage. Error:",c)}}l.resolve(a)});h.error(function(a,b){try{ldb.get(f,function(a){null!==a?l.resolve(JSON.parse(a)):"undefined"!==typeof localStorage[f]?l.resolve(JSON.parse(localStorage[f])):l.reject("ERROR")})}catch(c){try{"undefined"!==typeof localStorage[f]?l.resolve(JSON.parse(localStorage[f])):l.reject("ERROR")}catch(q){l.reject("ERROR")}}});
"undefined"!==typeof b&&d(function(){k.ldbOn?ldb.get(f,function(a){null!==a?l.resolve(JSON.parse(a)):""}):"undefined"!==typeof Storage&&f in localStorage&&l.resolve(JSON.parse(localStorage[f]))},b);"undefined"!==typeof e&&e["catch"](function(){l.reject("Canceled")});return l.promise}}]);app.controller("masterCtrl",["$http","$window","$rootScope","$routeParams","$scope","$location","$timeout","$injector","$q","initialJSON","$lhttp",function(a,g,d,k,f,b,h,e,l,r,p){var c=this,q=c.disabled=!1;c.norsk=(-1<navigator.language.indexOf("nb")||-1<navigator.language.indexOf("nn")||-1<navigator.language.indexOf("no")||-1<window.location.search.indexOf("lang=no"))&&!(-1<window.location.search.indexOf("lang=en"));c.desc="";c.games=[];c.categoryGames={};c.routeChanged=!1;c.verifiedUser=!1;c.otag=
"";c.tags=[];c.x=18;c.textData={};c.tagLimit=8;c.showAllTags=!1;c.allGamesAreDisplayed=function(){return c.games.length<c.x?!1:!0};r.json.then(function(a){Array.prototype.push.apply(c.games,a.initialGames);c.verifiedUser=a.verifiedUser;c.tags=a.topTags;c.x=a.count});c.requestGames=function(a){q||c.allGamesAreDisplayed()||(q=!0,a="//script.google.com/macros/s/AKfycbxGh5agyHkqBi5KbpYxl9G2gJlR5kuJzjJ--5BaP-KfcgaItx0/exec?from="+c.games.length+"&amount="+a+"&d="+Math.floor(Date.now()/36E5),0<r.pass.length&&
(a+="&pass="+r.pass),p.get(a,1400).then(function(a){Array.prototype.push.apply(c.games,a.data);q=!1})["catch"](function(a,b){console.log(a,b);q=!1}))};c.rate=function(a,b){};c.like=function(a){c.rate(a,"like.php",1)};c.dislike=function(a){c.rate(a,"dislike.php",-1)};c.ifDisabled=function(){return c.disabled};c.locChangeAlert="Please don't leave the page until the server has responded";c.norsk&&(c.locChangeAlert="Vennligst ikke forlat siden f\u00f8r serveren har svart");d.$on("$locationChangeStart",
function(a){c.disabled&&(a.preventDefault(),alert(c.locChangeAlert))});g.onbeforeunload=function(){if(c.disabled)return locChangeAlert};c.css="";c.mlcLoaded=!1;c.lazyModulesLoaded=!1;d.$on("$routeChangeSuccess",function(a){g.ga("send","pageview",{page:b.url()})});p.get("min/lazy-js.min.js",2E3).then(function(a){eval(a);c.lazyModulesLoaded=!0});a.get("src/js/objects/"+(c.norsk?"no":"en")+"-text.json").success(function(a){c.textData=a}).error(function(a,b){console.log(a,b);confirm("Unable to load textdata, do you want to reload the page?")?
location.reload(!0):null})}]);app.controller("categoryCtrl",["$http","$routeParams","$scope","initialJSON","$lhttp",function(a,g,d,k,f){var b=this;console.log(g);b.tag=g.category;b.x=1;d.master.loc="Thorin-Games \u2014 "+b.tag;d.master.desc="Here you can find all our games with the tag "+b.tag+" sorted by popularity";d.master.norsk&&(d.master.desc='Her kan du finne alle v\u00e5re spill med taggen "'+b.tag+'" sortert etter popularitet');b.games=[];b.tag in d.master.categoryGames&&(b.games=d.master.categoryGames[b.tag]);var h=b.noGames=
!1;f.get("//static.thorin-games.tk/php/count-games-in-db.php?tag="+b.tag+"&d="+Date.now()+"&pass="+k.pass,800).then(function(a){b.x=a;var e=d.master.desc,f=" games";d.master.norsk&&(f=" spill");d.master.desc=e.substring(0,e.indexOf(f))+" "+a+e.substring(e.indexOf(f));b.requestGames(18);0==b.x&&(b.noGames=!0)});b.requestGames=function(a){if(!h&&!b.allGamesAreDisplayed()){h=!0;var e=b.games.length;a=e+a;a>b.x&&(a=b.x);e="//static.thorin-games.tk/js/get-games-from-db.php?from="+e+"&to="+a+"&tag="+b.tag+
"&d="+Date.now()+"&pass="+k.pass;f.get(e,1500).then(function(a){Array.prototype.push.apply(b.games,a.data);h=!1;d.master.categoryGames[b.tag]=b.games})}};b.allGamesAreDisplayed=function(){return b.games.length<b.x?!1:!0}}]);app.controller("gameCtrl",["$scope","$routeParams","$http","$sce","$interval","$timeout","$q","$window","$rootScope","$location","initialJSON","$lhttp",function(a,g,d,k,f,b,h,e,l,r,p,c){function q(){/^[\d.,]+%$/.test(a.detail.height)&&p.jquery.then(function(){$("embed").ready(function(){b(function(){$("embed").attr("height",$("embed").width()*(Number(a.detail.height.split("%")[0])/100)+1)},1E3)})})}var m=!1,n=!1,t=0,z=h.defer(),u,A=.75*window.innerHeight,v="This game can't be played here. Click here to be redirected";
"https:"==location.protocol&&(location.protocol="http:");this.showGame=!1;a.master.norsk&&(v="Dette spillet kan ikke spilles her. Trykk her for \u00e5 bli videresendt til riktig side");a.noInstr=!1;c.get("//static.thorin-games.tk/js/get-games-from-db.php?id="+g.id+"&pass="+p.pass,1500).then(function(b){a.detail=b;console.log("data.mobile = (",typeof b.mobile,") ",b.mobile);a.master.loc="Thorin-Games \u2014 "+b.title;a.master.desc=b.description;2>a.detail.instructions.length&&(a.noInstr=!0);a.url=
k.trustAsResourceUrl(a.detail.file);"n"==a.detail.height&&(a.detail.height=A);"r"==a.detail.height||"r"==a.detail.width?(b=document.createElement("ul"),b.setAttribute("class","nav nav-pills redirect"),b.innerHTML='<li style="float:none"><a style="color:#fbfbfb" href="'+a.url+'">'+v+"</a></li>",document.getElementById("wrapper").appendChild(b)):$("embed").attr("src",a.url);q();u=Date.now()});var w=function(a,b){m=n=!0;var c=Date.now();d({method:"post",url:"//static.thorin-games.tk/php/"+b,data:a,headers:{"Content-Type":"application/x-www-form-url-encoded"}}).success(function(a){var b=
(Date.now()-c)/1E3;console.log("%cDin rating er sendt, requesten tok "+b+" sek, her er statistikk fra serveren:","font-family:ubuntu;color:#3c763d;background-color: #dff0d8;padding:3px;font-size:15px;");console.log(a.logdata);m=n=!1})};a.like=function(b){w(b,"like.php",1);a.detail.likes+=1};a.dislike=function(b){w(b,"dislike.php",-1);--a.detail.likes};a.refresh=function(){m=n=!0;Date.now();d.get("//static.thorin-games.tk/js/get-games-from-db.php?id="+g.id+"&pass="+p.pass+"&dt="+Date.now()).success(function(b){a.detail.comments=
b.comments;Date.now();u=Date.now();m=n=!1})};a.ifAnyChanges=function(){if(m||n)8<t?(a.detail.comments=[{com:"Lost contact with server - trying to reconnect",author:"..."}],m=!1,t++):(t++,console.warn("Skulle sjekke om kommentarene m\u00e5tte oppdateres, men avbr\u00f8t fordi forrige request ikke er besvart, dette har skjedd "+t+" gang(er)."));else{m=!0;var b="//static.thorin-games.tk/php/check-if-db-changed.php?"+Math.floor(Date.now()/1E4);Date.now();b=d({method:"post",url:b,ignoreLoadingBar:!0,data:{index:g.id,
coms:a.detail.comments.length},timeout:z.promise});b.success(function(b){var c=Date.now();m=!1;t=0;JSON.parse(b)&&a.refresh();b=u-c;for(c=0;c<a.detail.comments.length;c++)a.detail.comments[c].date||(a.detail.comments[c].date=1459870175813),a.detail.comments[c].date+=b/1E3});b.error(function(a,b){m=!1;console.error("$scope.ifAnyChanges() failed. The data returned was: "+a+" and the status code: "+b)})}};var C=f(a.ifAnyChanges,2400);a.$on("$destroy",function(){f.cancel(C)});try{a.author=localStorage.username}catch(D){a.author=
""}a.comment="";a.submit=function(){if(!n)if(0<a.comment.length&&0<a.author.length){a.commentForm.comment.$setUntouched();a.commentForm.author.$setUntouched();try{localStorage.username=a.author}catch(B){console.log(B)}m=n=!0;Date.now();var b=d({method:"post",url:"//static.thorin-games.tk/php/comment-in-db.php",data:{index:g.id,com:a.comment,author:a.author,date:Date.now()}});b.success(function(b){n=!1;Date.now();a.detail.comments=b.comments;a.comment="";a.tab=1;m=!1});b.error(function(a){alert("Your message was not submitted.\nPlease try again.");
n=m=!1})}else a.commentForm.comment.$setTouched(),a.commentForm.author.$setTouched()};a.ifDisabled=function(){return n};l.$on("$locationChangeStart",function(b){n&&(b.preventDefault(),alert(a.master.locChangeAlert))});e.onbeforeunload=function(){if(n)return locChangeAlert};a.goBack=function(){a.master.routeChanged?e.history.back(1):r.path("/")};var x,y;this.scrollDown=function(){$("html, body").animate({scrollTop:$(document).height()},1E3)};this.jquery=function(){var b=$("textarea").outerHeight();
$("textarea").keyup(function(){var c=$("form.com-container>div").height()-24;$("a.glyphicon[type=submit]").css("line-height",c+"px");x=$("textarea").width()*(30/270);y=Math.floor($("textarea").val().length/x)+1;$("textarea").css("height",y*b+"px");a.view.ifMobile||$("html, body").animate({scrollTop:$(document).height()})});$(window).resize(q)};p.jquery.then(this.jquery);a.ifSpace=function(){return 140<window.innerWidth-document.querySelector("embed").clientWidth&&!a.view.ifMobile}}]);app.controller("viewCtrl",function(){this.ifMobile="ontouchstart"in window;this.ifATHd=function(){if(ios)return!standalone&&safari?!1:standalone&&!safari?!0:standalone||safari?!1:!0};this.showHeader=function(){return-1<window.location.href.indexOf("/id/")?!1:!0}});app.directive("paraBack",["$window",function(a){return function(g,d,k){d.css("background-image","url("+k.paraBack+")");d.css("background-attachment","fixed");var f=Infinity,b=new Image;b.src=k.paraBack;b.onload=function(){f=b.height-window.innerHeight;d.css("background-position-x",-(b.width/2-d[0].offsetWidth/2)+"px")};var h=function(){var a=Math.floor(.1*this.pageYOffset);a<f&&d.css("background-position-y","-"+a+"px")};g.view.ifMobile||(angular.element(a).on("scroll",h),g.$on("$destroy",function(){angular.element(a).off("scroll",
h)}))}}]);